---
// src/components/PostHog.astro
// Cookieless analytics - no banner required

const posthogKey = import.meta.env.PUBLIC_POSTHOG_KEY;
const posthogHost = import.meta.env.PUBLIC_POSTHOG_HOST;
const platformUrl = import.meta.env.PUBLIC_PLATFORM_URL;
---
<!-- Inject config for inline script -->
<script is:inline define:vars={{ posthogKey, posthogHost, platformUrl }}>
    // Detect environment
    function getEnvironment() {
        const hostname = window.location.hostname;
        if (hostname === 'localhost' || hostname === '127.0.0.1') return 'local';
        if (hostname.includes('-dev.tlacu.mx')) return 'dev';
        if (hostname.includes('tlacu.mx')) return 'prod';
        return 'local';
    }

    // Check if PostHog should be disabled
    function shouldDisablePostHog() {
        const env = getEnvironment();
        // Don't send events from localhost
        if (env === 'local') return true;
        // Optionally: don't send from dev either (uncomment if needed)
        // if (env === 'dev') return true;
        return false;
    }

    // Skip PostHog initialization in localhost
    if (shouldDisablePostHog()) {
        console.log('[PostHog] Disabled in local environment');
    } else {
        // PostHog initialization
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group identify setPersonProperties setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags resetGroups onFeatureFlags addFeatureFlagsHandler onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);

        posthog.init(posthogKey, {
            api_host: posthogHost,
            persistence: 'memory', // Cookieless mode
            disable_persistence: true, // No localStorage either
            disable_cookie: true,
            defaults: '2025-11-30'
        });

        // Set environment as super property (included in all events)
        const environment = getEnvironment();
        posthog.register({
            environment: environment,
            site: 'landing'
        });
    }

    // Store platform URL for link attribution
    window.__TLACU_PLATFORM_URL__ = platformUrl;

    // Add distinct_id to platform links for attribution tracking
    document.addEventListener('DOMContentLoaded', function() {
        const platformLinks = document.querySelectorAll('a[data-platform-link]');
        platformLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                if (window.posthog && typeof posthog.get_distinct_id === 'function') {
                    const url = new URL(link.href);
                    const distinctId = posthog.get_distinct_id();
                    if (distinctId) {
                        url.searchParams.set('ph_id', distinctId);
                        link.href = url.toString();
                    }
                }
            });
        });
    });
</script>
